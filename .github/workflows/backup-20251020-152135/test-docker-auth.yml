name: Test Docker Hub Authentication

on:
  workflow_dispatch:

jobs:
  test-docker-auth:
    runs-on: ubuntu-latest
    steps:
    - name: Test Docker Hub Login
      if: secrets.DOCKER_HUB_USERNAME && secrets.DOCKER_HUB_TOKEN
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    
    - name: Test Base Image Pull
      run: |
        echo "🐳 Testing base image pull..."
        docker pull node:20-bookworm-slim
        echo "✅ Successfully pulled node:20-bookworm-slim"
    
    - name: Check Rate Limit Status
      run: |
        echo "📊 Checking Docker Hub rate limit status..."
        TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
        curl -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest -I 2>/dev/null | grep -i ratelimit || echo "Rate limit headers not found"
    
    - name: Cleanup
      if: always()
      run: docker logout
